<!DOCTYPE html>

<html>
<meta charset="utf-8">

<head>
<script src="jstorage.js"></script>
	<script>
	//$.jStorage.set(key, value, options)
	//console.log($.jStorage.index()); retourne un array
	//$.jStorage.flush()
	//$.jStorage.getTTL("mykey");
	//$.jStorage.deleteKey(key)
	//console.log($.jStorage.storageSize()); taille des données en mémoire
	//console.log($.jStorage.storageAvailable());
	var data = [];
	var idForOption = 0;
	
function charger(){
	data = $.jStorage.get("data");
	if(!data){ //si données inexistantes
		data = [[0, "todo", "ma tache 1", "important"],
				[1, "todo", "ma tache 2", "normal"],
				[2, "todo", "ma tache 3", "urgent"],]
		//data[x][0] : id | data[x][1] : type | data[x][2] : title | data[x][3] : tag(s)
		$.jStorage.set("data",data);
	}else //useless
		console.log(data);
}

function genererStructure(){
	for(i=0; i<data.length; i++){
		if(data[i][1] == "todo"){
			newItem(data[i][0], "todo", data[i][2], false);
		}
	}
}

function newItem(id, type, content, addNewTask){
	check = "";
	if(addNewTask && type=='todo')
		id = data.length; //id actuel du nouveau item
		
	document.getElementById("board").innerHTML += '<input id="'+id+'" type="checkbox" name="done" value="1" onchange="isDone(this)" '+check+' /><input size="100" id="task'+id+'" type="text" value="'+content+'" onBlur="editTask(this); this.style=\'background:#F0F0F0;\'" onClick="this.style=\'background:white;\'" onmouseover="afficherOption(this)"  /><input type="button" id="f'+id+'" class="option" value="facultatif" /><input type="button" class="option" value="important" id="i'+id+'" /><input type="button" class="option" value="urgent" id="u'+id+'" />';

	if(addNewTask && type=='todo')
		document.getElementById('task'+id).focus();
		//document.getElementById("task"+id).style="background:white;"; //à modifier input ne reprend pas la couleur
	else
		document.getElementById("board").innerHTML += '<br>';
}

function isDone(content){
	if(content.checked){
		document.getElementById('task'+content.id).setAttribute('class', 'done');
		data[parseInt(content.id)][0] = 'done';
	}
	else{
		document.getElementById('task'+content.id).removeAttribute('class');
		data[parseInt(content.id)][0] = 'todo';
	}
	//console.log(data[parseInt(content.id)][0]);
}

function editTask(content){
	var id = parseInt(content.id.slice(4), 10);
	//console.log(id+':'+data.length+'value :'+content.value);
	if (id != data.length && content.value != ''){
		/*if(content.value == data[id][2])
			console.log("ok");*/
		content.setAttribute('value', content.value);
		data[id][2] = content.value;
		console.log(content.value);
		
	}
	else if(id == data.length && content.value.length >= 1){ //si nouvel item alors ajout dans le tableau
		data.push([id, 'todo', content.value, 'normal']);
		content.setAttribute('value', content.value);
		document.getElementById('board').innerHTML += '<br>';
	}
	
	else{ // si nouveau item ne contient alors, on supprime les inputs associés
		element = document.getElementById(id);
		element.parentNode.removeChild(element);
		element = document.getElementById(content.id);
		element.parentNode.removeChild(element);
	}

}

function afficherOption(content){ //onclick ou focus (plutot onfocus) //permet d'afficher les boutons d'options
	//content.setAttribute('class', 'oo');
	var id = idForOption =content.id.slice(4);
	
	document.getElementById('f'+id).setAttribute('class', 'oo');
	document.getElementById('i'+id).setAttribute('class', 'oo');
	document.getElementById('u'+id).setAttribute('class', 'oo');
	console.log(id);
	window.setTimeout("cacherOption(idForOption)", 3000);
}

function cacherOption(idz){
	//var id = content.id.slice(4);
	document.getElementById('f'+idz).setAttribute('class', 'option');
	document.getElementById('i'+idz).setAttribute('class', 'option');
	document.getElementById('u'+idz).setAttribute('class', 'option');
}

charger();
	
	</script>
	
	<style>
	input[type='text']{ 
		border:none;
		background:#F0F0F0;
		height:30px;
		margin:1px -150px 1px 0px;
		padding-left:10px;
	}
	
	.done{
		background:#E3E3E3;
		text-decoration:line-through;
		color:#C2C2C2;
	}
	
	.important{
		background:orange;
	}
	
	.urgent{
		background:red;
	}
	
	.facultatif{
		background:green;
	}
	
	.option{
		visibility:hidden;
	}
	</style>
</head>

<body>

<div id="board" >Mes tâches<br></div>
<input type="button" onClick="newItem(0, 'todo', '', true);" value="New task" />
<input type="button" onClick="console.log(data);" value="dev" />
<input style="border-radius:20px; color:orange;" type="button" value="essai" />

<div id="test"></div>
<br>

<script>
window.onload = genererStructure();
</script>

</body>



</html>
